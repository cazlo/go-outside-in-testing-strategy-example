name: CI

on:
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run CI tests
        run: make ci-test

  integration:
    name: Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run integration tests
        run: make ci-test-integration

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all artifacts
        run: make ci-build

  k8s-test:
    name: Kubernetes Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          wait: 30s

      - name: Build Docker image
        run: docker build --target prod -t go-outside-in:test .

      - name: Load image into kind
        run: kind load docker-image go-outside-in:test --name test-cluster

      - name: Deploy wiremock
        run: kubectl apply -f k8s/wiremock.yaml

      - name: Wait for wiremock to be ready
        run: kubectl wait --for=condition=ready pod -l app=wiremock --timeout=60s

      - name: Deploy application
        run: kubectl apply -f k8s/app.yaml

      - name: Wait for application rollout
        run: kubectl rollout status deployment/go-outside-in --timeout=90s

      - name: Wait for application to be ready
        run: kubectl wait --for=condition=ready pod -l app=go-outside-in --timeout=60s

      - name: Port forward application
        run: |
          kubectl port-forward service/go-outside-in 8080:8080 &
          sleep 5

      - name: Run blackbox tests against Kubernetes deployment
        run: BASE_URL=http://localhost:8080 go test ./test/blackbox -count=1 -v

      - name: Debug - Show pods on failure
        if: failure()
        run: |
          kubectl get pods
          kubectl describe pods
          kubectl logs -l app=go-outside-in --tail=100
          kubectl logs -l app=wiremock --tail=100
